!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).kbyte=t()}(this,function(){"use strict";var e;e="undefined"!=typeof window?window.WebSocket:require("ws");var t=function(e,n){setTimeout(function(){1===e.readyState?null!==n&&n():t(e,n)},5)};return{Client:function(){function n(t){var n=this;this.address=t,this.ws=new e(t),this.queue={},this.notifications=[],this.open=!1,this.ws.addEventListener("message",function(e){var t=JSON.parse(e.data);if(t&&Array.isArray(t)&&2===t.length)if(n.queue[t[1].tag]){var s=t[1].response.error||null,i=s?null:t[1].response,o=n.queue[t[1].tag];delete n.queue[t[1].tag],o(s,i)}else n.notifications.forEach(function(e){return e(t)})}),this.ws.addEventListener("open",function(){n.open=!0}),this.ws.addEventListener("close",function(){n.open=!1})}return n.prototype.subscribe=function(e){this.notifications.push(e)},n.prototype.send=function(e){var n=this;t(this.ws,function(){n.ws.send(JSON.stringify(e))})},n.prototype.request=function(e,t,n){var s={command:e,params:t,tag:Math.random().toString(36).substring(7)};this.queue[s.tag]=n,this.send(["request",s])},n.prototype.respond=function(e,t,n){var s={command:e,tag:t};void 0!==n&&(s.response=n),this.send(["response",s])},n.prototype.error=function(e,t,n){this.respond(e,t,{error:n})},n.prototype.justsaying=function(e,t){var n={subject:e,body:t};this.send(["justsaying",n])},n}()}});
